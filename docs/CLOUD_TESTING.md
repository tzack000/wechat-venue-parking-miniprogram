# 云开发测试指南

本文档指导你如何使用微信云开发进行完整测试。

## 前置要求

1. **微信开发者工具**（最新稳定版）
2. **微信小程序 AppID**（已注册的小程序账号）
3. **开通云开发**（免费额度足够测试）

---

## 第一步：配置项目

### 1.1 修改 AppID

编辑 `project.config.json`，将第 42 行的 AppID 替换为你的实际 AppID：

```json
"appid": "你的实际AppID"
```

### 1.2 确认 Mock 模式已关闭

检查 `miniprogram/app.js` 第 5 行：

```javascript
const USE_MOCK = false  // 确保为 false
```

---

## 第二步：开通云开发

### 2.1 导入项目

1. 打开微信开发者工具
2. 点击「导入项目」
3. 选择项目目录
4. 填入你的 AppID
5. 点击「导入」

### 2.2 开通云开发

1. 点击工具栏的「云开发」按钮
2. 点击「开通」
3. 填写环境名称（如：`venue-booking-dev`）
4. 选择「按量付费」（测试够用）
5. 点击「确定」创建环境

### 2.3 记录环境 ID

创建完成后，在云开发控制台左上角可以看到环境 ID，格式类似：
```
venue-booking-dev-xxxxxxx
```

### 2.4 配置环境 ID

编辑 `miniprogram/app.js` 第 24 行：

```javascript
wx.cloud.init({
  env: 'venue-booking-dev-xxxxxxx', // 替换为你的环境ID
  traceUser: true
})
```

---

## 第三步：创建数据库集合

在云开发控制台 → 数据库，创建以下集合：

| 集合名称 | 说明 |
|---------|------|
| `users` | 用户信息 |
| `venues` | 场馆信息 |
| `bookings` | 预约记录 |
| `parking_records` | 停车记录 |
| `parking_config` | 停车配置 |

### 设置集合权限

为方便测试，可以临时将所有集合权限设为「所有用户可读，仅创建者可写」：

1. 点击集合名称
2. 点击「权限设置」
3. 选择「所有用户可读，仅创建者可写」
4. 点击「确定」

> 正式上线前需要根据业务需求调整权限

---

## 第四步：上传云函数

在开发者工具左侧「cloudfunctions」目录下，依次右键每个云函数文件夹，选择「上传并部署：云端安装依赖」：

1. **user** - 用户模块
2. **venue** - 场馆模块
3. **booking** - 预约模块
4. **parking** - 停车模块
5. **admin** - 管理员模块
6. **initTestData** - 测试数据初始化（可选）

上传顺序不重要，等待所有云函数上传完成。

---

## 第五步：初始化测试数据

### 方法一：使用云函数（推荐）

1. 在云开发控制台 → 云函数 → 找到 `initTestData`
2. 点击「云端测试」
3. 测试参数填写：
   ```json
   {
     "action": "all",
     "clear": true
   }
   ```
4. 点击「运行测试」
5. 等待返回成功结果

### 方法二：手动导入 JSON

在云开发控制台 → 数据库，对每个集合点击「导入」：

| 集合 | 导入文件 |
|-----|---------|
| venues | `database/test_data/venues.json` |
| users | `database/test_data/users.json` |
| bookings | `database/test_data/bookings.json` |
| parking_records | `database/test_data/parking_records.json` |
| parking_config | `database/test_data/parking_config.json` |

---

## 第六步：开始测试

### 6.1 编译预览

1. 点击开发者工具顶部的「编译」按钮
2. 在模拟器中查看小程序

### 6.2 功能测试清单

#### 用户模块
- [ ] 点击「我的」Tab 进入个人中心
- [ ] 点击头像区域触发微信登录授权
- [ ] 登录成功后显示用户信息

#### 场馆预约
- [ ] 点击「场馆预约」Tab 查看场馆列表
- [ ] 点击场馆查看详情
- [ ] 选择日期查看可用时段
- [ ] 选择时段进入预约确认页
- [ ] 填写信息提交预约
- [ ] 在「我的预约」查看预约记录
- [ ] 取消预约

#### 停车登记
- [ ] 点击「停车登记」Tab
- [ ] 填写车牌号（如：粤A12345）和访问目的
- [ ] 提交登记，查看二维码凭证
- [ ] 进行车位预约
- [ ] 查看停车记录

#### 管理员功能
首先设置管理员权限：
1. 在云开发控制台 → 数据库 → users
2. 找到你的用户记录（根据登录后的 openid 查找）
3. 将 `isAdmin` 字段改为 `true`

然后测试：
- [ ] 在「我的」页面看到「管理后台」入口
- [ ] 进入管理后台
- [ ] 场馆管理：添加/编辑/停用场馆
- [ ] 预约管理：查看/审核/拒绝预约
- [ ] 停车管理：查看记录/手动登记/确认进出

---

## 调试技巧

### 查看云函数日志

1. 云开发控制台 → 云函数
2. 点击函数名称 → 「日志」
3. 查看调用记录和错误信息

### 查看数据库数据

1. 云开发控制台 → 数据库
2. 点击集合名称查看数据
3. 可以手动添加/修改/删除记录

### 模拟器调试

1. 开发者工具 → Console 面板查看日志
2. Network 面板查看云函数请求
3. AppData 面板查看页面数据

### 真机调试

1. 点击「预览」生成二维码
2. 用微信扫码在手机上测试
3. 点击「真机调试」可以在电脑上看手机日志

---

## 常见问题

### Q: 云函数调用失败 -404

**原因**：云函数未上传或环境 ID 错误

**解决**：
1. 检查云函数是否已上传（云开发控制台可查看）
2. 检查 `app.js` 中的环境 ID 是否正确

### Q: 数据库读取失败

**原因**：集合不存在或权限不足

**解决**：
1. 检查集合是否已创建
2. 检查集合权限设置

### Q: 登录后显示未登录

**原因**：用户信息未正确保存

**解决**：
1. 清除小程序缓存重新登录
2. 检查 users 集合中是否有用户记录

### Q: 预约时段都显示"已过期"

**原因**：选择的日期是过去的日期

**解决**：选择今天之后的日期进行预约

---

## 发布前检查清单

- [ ] Mock 模式已关闭（`USE_MOCK = false`）
- [ ] 环境 ID 已配置正确
- [ ] 所有云函数已上传最新版本
- [ ] 数据库集合权限已正确设置
- [ ] 已在真机上完成测试
- [ ] 删除测试数据，导入正式初始数据
